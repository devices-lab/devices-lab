<script lang="ts">
	import BaseCard from '$lib/components/BaseCard.svelte';
	import { type ResearchItem, DefaultResearchItem, generateKey } from '$lib/data/research';
	import ResearchInput from '$lib/workbench/bibtex/ResearchInput.svelte';
	import { Download, X } from '@lucide/svelte';

	import BaseButton from '$lib/components/BaseButton.svelte';
	import Selectarea from '$lib/workbench/bibtex/inputs/Selectarea.svelte';
	import Textarea from '$lib/workbench/bibtex/inputs/Textarea.svelte';
	import type { PageProps } from './$types';

	const { data }: PageProps = $props();



	const clearData = () => {
		currentItem = { ...DefaultResearchItem };
		doi = '';
		selected = '';
	};
	const loadData = () => {
		if (selected && data.researchLibrary[selected]) {
			currentItem = data.researchLibrary[selected];
		}
	};
	const importData = () => {};
	const downloadData = () => {
		// generate key
		currentItem.key = generateKey(currentItem.name, currentItem.title);

		const { key, picture, ...data } = currentItem;
		let dataString = 
`
// Generated by Devices Lab https://deviceslab.org
import type { ResearchType } from "$lib/data/research";

export const research: ResearchType = ${JSON.stringify(data, null, 4)};
`;

		const link = document.createElement('a');
		link.href = URL.createObjectURL(new Blob([dataString], { type: 'text/plain' }));
		link.download = `${currentItem.key}.ts`;
		link.click();
		//notification?.show('success', 'Download ready!');
	};

	let currentItem: ResearchItem = $state({ ...DefaultResearchItem });

	const researchSelect = $derived([
		{ key: '', title: '' },
		...Object.entries(data.researchLibrary).map(([key, item]) => ({
			key,
			title: item.name
		}))
	]);


	let doi = $state('');
	let selected = $state('');
</script>

<BaseCard class="flex flex-col items-center justify-between gap-3 rounded-full! border-1 border-gray-200 px-8 shadow-md! sm:flex-row ">
	<div class="flex flex-1 items-center gap-3">
		<Textarea bind:value={doi} label="DOI" placeholder="Enter DOI" class="flex-1" />
		<BaseButton theme="primary" class="mt-2 rounded-lg" onclick={importData}>Import</BaseButton>
	</div>

	<div class="mx-4 text-xl font-light">or</div>

	<div class="flex flex-1 items-center gap-3">
		<Selectarea bind:value={selected} items={researchSelect} label="Research item" class="flex-1" />
		<BaseButton theme="primary" class="mt-2 rounded-lg" onclick={loadData}>Load</BaseButton>
	</div>

	<div class="mx-4 text-xl font-light"></div>

	<BaseButton theme="link-danger" class="ms-auto flex items-center gap-1 text-sm" onclick={clearData}>
		<X />
		Clear
	</BaseButton>
</BaseCard>

<BaseButton theme="success" class="ms-auto flex items-center gap-2 px-6 py-1 tracking-wider uppercase" onclick={downloadData}>
	<Download class="size-5" />
	Download
</BaseButton>

<ResearchInput bind:research={currentItem} />
